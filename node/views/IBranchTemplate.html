<!DOCTYPE html>
<html>
<head>
    <!--All your imports & meta tags-->
    <meta charset="UTF-8" />
    <title>Instance Branch Template</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- updte with summary gif-->   
    <!--<link rel="canonical" href="{{playloop_url}}">-->
    <meta property="og:url" content="{{summary_img}}">
    <meta property="og:type" content="video.other">
    <!--<meta property="og:url" content="{{playloop_url}}">-->
    <meta property="og:image" content="{{summary_img}}">
    <meta property="og:title" content="PlayLoops!" />
    <meta property="og:description" content="Click to play! Make your own at Playloops.io" />
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@Playloops">
    <meta name="twitter:creator" content="@playloops">
    <meta name="twitter:title" content="PlayLoops!">
    <meta name="twitter:description" content="Click to play! Make your own at Playloops.io">
    <meta name="twitter:image" content="{{summary_img}}">
    
    <!--oembed-->
    <!--<link rel="alternate" type="application/json+oembed" href="{{oembedurl_json}}" title="Playloop oembed profile" />
    <link rel="alternate" type="text/xml+oembed" href="{{oembedurl_xml}}" title="Playloop oembed profile" />-->
    
    <!-- Canvas Library --> 
    <script type="text/javascript" src="/js/fabric.min.js"></script>
    
    <!-- import JQuery --> 
    <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    
    <!-- spinner for loading --> 
    <script src="/js/spin.min.js"></script>
</head>
<body>
<section class="section main">
    <!--<div class="container left">
        <!-- Logo & Nav options --> 
        <!--<div class="div header">
           <img class="logo" src="/images/bluelogo.svg">  
        </div>
    </div>-->
    <div class="container middle" id="middlecontainer">
        <div class="canvascontainer" id="canvasesdiv">
            <!--Canvas with editor--> 
            <video class="video" id="videoElement" width="150" height="75" src="https://media.giphy.com/media/3rgXBvnbXtxwaWmhr2/giphy.mp4" style="display:none;" autoplay="autoplay" loop="loop"></video>
            <!--<canvas class="canvas main" id="maincanvas"></canvas>-->
        </div>
    </div>
    <!--<div class="container right">
        <!-- Edit Button 
        <button class="button edit" id="editbutton">Edit</button>-->
    <!--</div>-->
    <audio id="popAudio" src="/audio/cartoon.mp3" autostart="false" ></audio>
    <audio id="pushAudio" src="/audio/blinking.mp3" autostart="false" ></audio>
    <div style="font-family:'MyDosis'">&nbsp;</div>
    
    <!--<blockquote class="embedly-card">
        <h4><a href="http://embed.ly/docs">My PlayLoop</a></h4>
        <p>
          Play more at playloops.io!
        </p>
    </blockquote>
    -->
    
</section>
    
<!--<style class="embedly-css">
  @import url(https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300);
  .card {
    font-family: 'Open Sans Condensed', sans-serif;
  }
  .card a, .card .action {
    color: red;
  }
  .hdr {
    display:none;
  }
</style>
    
<style class="embedly-css">
  @import url(https://fonts.googleapis.com/css?family=Merriweather);
  .card {
    font-family: 'Merriweather', serif;
  }
  .card .title {
    margin-bottom:5px;
  }
  .card .action {
    color: #fa4b2a;
  }
</style>  -->  
    
<style> 
    /*display: table;*/
    .section.main{font-family: 'Oswald medium', sans-serif; background-color: black; height: 800px; width:100%; padding-top: 5%;}
    
    .container.left{ display: table-cell; width: 0%; vertical-align: top;}
    .container.middle{display: block; max-width: 100%; height: auto;/*border-style: solid; */text-align: center;/* background-color: gainsboro;*/}
    .container.right{ display: table-cell; width: 0%; vertical-align: top;}
    
    .canvascontainer{margin-left: auto; margin-right: auto; position: relative; }
    .canvas-container{margin-left: auto; margin-right: auto; position: absolute;left: 0; right: 0; }
    /*.lower-canvas, .upper-canvas{border-radius: 2.5%/5%;margin-top: 10%; margin-bottom: 10%;}
    .upper-canvas{box-shadow: 10px 10px 25px rgba(0,0,0,.5);}
    /*canvas{}*/
    /*.lower-canvas, .upper-canvas{
          border: 8px solid transparent;

          -moz-border-image: -moz-linear-gradient(left, #3acfd5 0%, #3a4ed5 100%);
          -webkit-border-image: -webkit-linear-gradient(left, #3acfd5 0%, #3a4ed5 100%);
          border-image: linear-gradient(to right, #3acfd5 0%, #3a4ed5 100%);

          border-image-slice: 1;
    }
    .lower-canvas::after, .upper-canvas::after {
        border-radius: 2.5%/5%;
        border: 8px solid transparent;
        -moz-border-image: -moz-linear-gradient(left, #3acfd5 0%, #3a4ed5 100%);
        -webkit-border-image: -webkit-linear-gradient(left, #3acfd5 0%, #3a4ed5 100%);
        border-image: linear-gradient(to right, #3acfd5 0%, #3a4ed5 100%);
        border-image-slice: 1;
        content: '';
        position: absolute;
    }*/
    .roundcorners{/*border-radius: 2.5%/5%;*/margin-top: 10%;}
    
    .shadowOutset{/*box-shadow: 10px 10px 25px rgba(0,0,0,.25);*/}
    .shadowInset{/*box-shadow: 10px 10px 25px rgba(0,0,0,.25) inset;*/}
    
    .video{margin-left: auto; margin-right: auto;}
    .div.header{margin: .5em;}
    .logo{width: 100%; height: auto; display: none;}
    
    .nodecanvas{padding: 12% 20% 0% 10%;}
    .modal.content { background-color: #fefefe;margin: auto;padding: 20px;border: 1px solid #888;width: 60%; height: 60%;}

    
    .button {border-style: solid; border-radius: 0px; padding: .5em; text-align: center; display: inline-block; font-size: 1em; cursor: pointer; box-shadow: none;  }
    
    @font-face
    {
        font-family: MyDosis;
        src: url('/fonts/BebasNeue.otf')
    }
</style>       

<script>
//Embedly importing player.js    
(function(w, d){
    var id='embedly-platform', n = 'script';
    if (!d.getElementById(id)){
     w.embedly = w.embedly || function() {(w.embedly.q = w.embedly.q || []).push(arguments);};
     var e = d.createElement(n); e.id = id; e.async=1;
     e.src = ('https:' === document.location.protocol ? 'https' : 'http') + '://cdn.embedly.com/widgets/platform.js';
     var s = d.getElementsByTagName(n)[0];
     s.parentNode.insertBefore(e, s);
    }
})(window, document);
//End Embedly stuff
    
//var canvas = new fabric.Canvas('maincanvas');
// Add a new rectangular canvas with fill representing specified gradient
var allCanvases = []; 
var allFabricObjects = []; 
var allStartEndTimes = []; 
var allVideos = []; 
var orderType = "ordered";//ordered or randomized
var inputType = "click"; //click or hold
var transitionType = "default";//default or break
    
function addTimeHandler(nVideo, startTime, endTime){
    nVideo.addEventListener('timeupdate', parentVideoListener(nVideo, startTime, endTime));
}
var parentVideoListener = function (nVideo, sT, eT) {
    return function(err) { 
            if (nVideo.currentTime >= eT) {
                nVideo.pause(); 
                nVideo.currentTime = sT;
                nVideo.play();
                console.log("in newVideo callback");
            }
    };
};    
    
$(document).ready(function(){
    
                
                orderType = {{order | safe |json}};   
                inputType = {{inputType | safe |json}};   
                transitionType = {{transition | safe |json}};   

                var scenes = {{scenes | safe |json}};   
                //jsonData['scenes']
                for(var j = 0; j < scenes.length; j++){
                    //create div to hold the canvas for the scene
                    var canvasDiv = document.getElementById("canvasesdiv");
                    var newCanvas = document.createElement("canvas");
                    canvasDiv.appendChild(newCanvas);
                    var canvas = new fabric.Canvas(newCanvas, {width: 500, height:50});
                    newCanvas.parentElement.style.position = "absolute";
                    
                    
                    var canvasStr = scenes[j];
                    
                    var sceneJSON = JSON.parse(canvasStr); 
                    var sceneObjects = sceneJSON.objects;
                    canvas.setHeight(sceneJSON.height);
                    canvas.setWidth(sceneJSON.width);
                    if(j == 0){
                        $("#middlecontainer").height(sceneJSON.height + (.2*document.body.offsetHeigh));
                    }
                    
                    for (var i = 0; i < sceneObjects.length; i++) {
                        var klass = fabric.util.getKlass(sceneObjects[i].type);
                        
                        if (sceneObjects[i].name == "video") {
                            console.log("object type: " + sceneObjects[i].type);
                            console.log("object src: " + sceneObjects[i].src);
                            
                            var newVideo = document.createElement("video");
                            newVideo.src = sceneObjects[i].src; 
                            newVideo.style.display = "none";
                                                            
                            var startTime = 0; 
                            var endTime = sceneObjects[i].duration; 
                            var urlText = sceneObjects[i].src;
                            var indexTC = urlText.indexOf("#t=");
                            if(indexTC != "-1"){
                                var timeCodes = urlText.slice(indexTC+3).split(","); 
                                console.log("!!!!!!!!!!!timeCodes: " + timeCodes[0] + " :: " + timeCodes[1]); 
                                startTime = timeCodes[0]; 
                                endTime = timeCodes[1];    
                            }
                            //var timeCodes = urlText.slice(indexTC+3).split(","); 
                           
                            
                            allStartEndTimes.push({"s":startTime, "e":endTime});

                            allVideos.push(newVideo); 
                            if(j == 0 || inputType == "hold")
                            {                                
                                addTimeHandler(newVideo, parseFloat(startTime), parseFloat(endTime));
                            }

                            var backVideo = document.createElement("video");
                            backVideo.src = newVideo.src;
                            backVideo.style.display = "none";

                            console.log("inbackVideo"); 
                            backVideo.addEventListener("loadeddata", function(sT){
                                return function(err) { 
                                    backVideo.currentTime = sT;
                                    console.log("in backVideo callback");
                                };
                            }(startTime), false);

                            canvasDiv.appendChild(backVideo);

                            var videoB = new fabric.Image(backVideo, {
                                  left: sceneObjects[i].left,
                                  top: sceneObjects[i].top,
                                  width: sceneObjects[i].width, 
                                  height: sceneObjects[i].height
                            });

                            canvas.add(videoB);
                            
                            canvasDiv.appendChild(newVideo);
                            
                            var videoT = new fabric.Image(newVideo, {
                                  left: sceneObjects[i].left,
                                  top: sceneObjects[i].top,
                                  width: sceneObjects[i].width, 
                                  height: sceneObjects[i].height
                            });
                            
                            canvas.add(videoT);
                            videoT.getElement().play();
                            canvas.renderAll();
                        
                        } else {
                            if(sceneObjects[i].name != "cursor"){
                                var aObj = klass.fromObject(sceneObjects[i]);
                                canvas.add(aObj);
                                //aObj.fontFamily = 'MyDosis';   
                                //canvas.renderAll();
                            }
                        }
                    }
                    
                    allFabricObjects.push(canvas);
                    allCanvases.push(newCanvas);
                    
                    //add button gloss
                    if(j == 0){
                        fabric.Image.fromURL('/images/ButtonGloss-01.png', function(myImg) {
                            //i create an extra var for to change some image properties
                            var img1 = myImg.set({ left: 0, top: 0 ,width:sceneJSON.width,height:sceneJSON.height});
                            allFabricObjects[0].add(img1);
                            allFabricObjects[0].renderAll(); 
                        });
                    }
                    
                    if(j != 0){
                        $(newCanvas).hide();
                    }
                    if(j == (scenes.length-1) ){
                        canvas.on('after:render', initLook);    
                    }
                    
                }
                

    var initLook = function(e){
        allFabricObjects[(allFabricObjects.length-1)].off('after:render', initLook);
        if(transitionType == "default"){
            $(".upper-canvas").addClass("roundcorners");
            $(".upper-canvas").addClass("shadowOutset");
            $(".lower-canvas").addClass("roundcorners");
        }
    };
   
    
    
    fabric.util.requestAnimFrame(function render() {
        for(var i =0; i < allCanvases.length; i++){
            allFabricObjects[i].renderAll();            
        }
        fabric.util.requestAnimFrame(render);
    });

  
    $("#middlecontainer").on('mousedown',function(){
        //$(".lower-canvas").css('box-shadow', '10px 10px 25px rgba(0,0,0,.5) inset');
        //$(".upper-canvas").css('box-shadow', '10px 10px 25px rgba(0,0,0,.5) inset');
        if(inputType == "hold"){
            //call change of scene
            showChildScene(); 
        }
    });
    
    $("#middlecontainer").on('mouseup',function(){
       /* var myH = $(".lower-canvas").height();
        var myW = $(".lower-canvas").width();
        var myL = $(".lower-canvas").position().left; 
        var myT = $(".lower-canvas").position().top; 
        $(".lower-canvas").animate({height: (myH+20).toString(), width: (myW+20).toString(), left: (myL-10).toString(), top: (myT-10).toString()}, 150);
        $(".lower-canvas").animate({height: (myH).toString(), width: (myW).toString(), left: (myL).toString(), top: (myT).toString()}, 100);
        $(".lower-canvas").css('box-shadow', '10px 10px 25px rgba(0,0,0,.5)');*/
        if(inputType == "hold"){
            //end the child scene 
            hideChildScene(); 
        }
    });
    
    //implement InstanceBranching logic on click/click-hold switch out the canvases. 
    $( "#middlecontainer" ).on('touchend click', function(){
        console.log("clicked!");
       if(inputType == "click"){
           showChildScene(); 
       }    
    });
    
    function showChildScene(){
         if(openForInput == true){
            console.log("should play second clip");
            openForInput = false;
            
            //get parent video, remove its event listener & hide its canvas
            parentVid = allVideos[0];
            parentVid.muted = true; 
            //parentVid.removeEventListener("timeupdate", parentVideoListener);
            $(allCanvases[0]).hide();
            
            //pick the next child scene, show its canvas, get it's video and set it to its start and play it. 
            console.log("max: " + (allCanvases.length-1)); 
            if(orderType == "randomized"){
                nextChildNum = getRandomInt(1, (allCanvases.length-1));
            }
            else{
                if((nextChildNum + 1) >  (allCanvases.length-1)){
                    nextChildNum = 1;         
                }else{
                    nextChildNum++;      
                }
            }
            $(allCanvases[nextChildNum]).show();
            currentVidEl = allVideos[nextChildNum];
            currentVidEl.pause();
            currentVidEl.currentTime = allStartEndTimes[nextChildNum].s;
            currentVidEl.play();
            
            currentVidS = allStartEndTimes[nextChildNum].s; 
            currentVidE = allStartEndTimes[nextChildNum].e; 
            
            //add a listener to the child video so you can turn it off once it's done playing or reaches its end
            hideOnce = true; 
            //console.log("randINt getting sent over: " + nextChildNum); 
            if(inputType =="click"){
                addSecondTimeHandler();
            }
        
            $(".upper-canvas").removeClass("shadowOutset").addClass("shadowInset");// css('box-shadow', '10px 10px 25px rgba(0,0,0,.5) inset');   
            var pushSound = document.getElementById("pushAudio");
            pushSound.play();
        }
    }
    
}); 
    
var parentVid = null;     
var hideOnce = true; 
var openForInput = true;  
var nextChildNum = 0; 
var currentVidEl;
var currentVidS; 
var currentVidE; 
function addSecondTimeHandler(){
    console.log("in addhandler lkajs dlfkj fuck im");
    currentVidEl.addEventListener('timeupdate', childVideoListener);
} 
    
var childVideoListener = function (){
    //console.log("currentTime: " + currentVidEl.currentTime + "supposed: " + currentVidE); 
    if (currentVidEl.currentTime >= currentVidE) {
        //make sure parent doesn't get set multiple times. 
        if(hideOnce == true){
            hideOnce = false; 
            hideChildScene(); 
        }
    }
};    
  
function hideChildScene(){
    //hide the child canvas and show the parent canvas
    $(allCanvases[nextChildNum]).hide();
    $(allCanvases[0]).show();

    //set parent video start time & play
    parentVid.currentTime = allStartEndTimes[0].s;
    parentVid.play();
    parentVid.muted = true; 
    //add the time handler back to the parent so it can loop
    addTimeHandler(parentVid, allStartEndTimes[0].s, allStartEndTimes[0].e);
    //open to listen to input again
    openForInput = true;
    //don't need this event listener anymore
    currentVidEl.removeEventListener('timeupdate', childVideoListener);   

    var myH = $(".lower-canvas").height();
    var myW = $(".lower-canvas").width();
    var myL = $(".lower-canvas").position().left; 
    var myT = $(".lower-canvas").position().top; 
    $(".lower-canvas").animate({height: (myH+20).toString(), width: (myW+20).toString(), left: (myL-10).toString(), top: (myT-10).toString()}, 150);
    $(".lower-canvas").animate({height: (myH).toString(), width: (myW).toString(), left: (myL).toString(), top: (myT).toString()}, 100);
    $(".upper-canvas").animate({height: (myH+20).toString(), width: (myW+20).toString(), left: (myL-10).toString(), top: (myT-10).toString()}, 150);
    $(".upper-canvas").animate({height: (myH).toString(), width: (myW).toString(), left: (myL).toString(), top: (myT).toString()}, 100);

    //$(".upper-canvas").css('box-shadow', '10px 10px 25px rgba(0,0,0,.5)');
    $(".upper-canvas").removeClass("shadowInset").addClass("shadowOutset");
    //var sound = document.getElementById("popAudio");
    //sound.play();
}    
    
function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}
    

/********************!!!!!!!!!!!!!!!!!!!*******************/
    var video;
var copy;
var copycanvas;
var draw;

var TILE_WIDTH = 32;
var TILE_HEIGHT = 24;
var TILE_CENTER_WIDTH = 16;
var TILE_CENTER_HEIGHT = 12;
var SOURCERECT = {x:0, y:0, width:0, height:0};
var PAINTRECT = {x:0, y:0, width:1000, height:600};

function init(){
	video = document.getElementById('sourcevid');
	copycanvas = document.getElementById('sourcecopy');
	copy = copycanvas.getContext('2d');
	var outputcanvas = document.getElementById('output');
	draw = outputcanvas.getContext('2d');
	setInterval("processFrame()", 33);
}
function createTiles(){
	var offsetX = TILE_CENTER_WIDTH+(PAINTRECT.width-SOURCERECT.width)/2;
	var offsetY = TILE_CENTER_HEIGHT+(PAINTRECT.height-SOURCERECT.height)/2;
	var y=0;
	while(y < SOURCERECT.height){
		var x=0;
		while(x < SOURCERECT.width){
			var tile = new Tile();
			tile.videoX = x;
			tile.videoY = y;
			tile.originX = offsetX+x;
			tile.originY = offsetY+y;
			tile.currentX = tile.originX;
			tile.currentY = tile.originY;
			tiles.push(tile);
			x+=TILE_WIDTH;
		}
		y+=TILE_HEIGHT;
	}
}

var RAD = Math.PI/180;
var randomJump = false;
var tiles = [];
var debug = false;
function processFrame(){
	if(!isNaN(video.duration)){
		if(SOURCERECT.width == 0){
			SOURCERECT = {x:0,y:0,width:video.videoWidth,height:video.videoHeight};
			createTiles();
		}
		//this is to keep my sanity while developing
		if(randomJump){
			randomJump = false;
			video.currentTime = Math.random()*video.duration;
		}
		//loop
		if(video.currentTime == video.duration){
			video.currentTime = 0;
		}
	}
	var debugStr = "";
	//copy tiles
	copy.drawImage(video, 0, 0);
	draw.clearRect(PAINTRECT.x, PAINTRECT.y,PAINTRECT.width,PAINTRECT.height);
	
	for(var i=0; i<tiles.length; i++){
		var tile = tiles[i];
		if(tile.force > 0.0001){
			//expand
			tile.moveX *= tile.force;
			tile.moveY *= tile.force;
			tile.moveRotation *= tile.force;
			tile.currentX += tile.moveX;
			tile.currentY += tile.moveY;
			tile.rotation += tile.moveRotation;
			tile.rotation %= 360;
			tile.force *= 0.9;
			if(tile.currentX <= 0 || tile.currentX >= PAINTRECT.width){
				tile.moveX *= -1;
			}
			if(tile.currentY <= 0 || tile.currentY >= PAINTRECT.height){
				tile.moveY *= -1;
			}
		}else if(tile.rotation != 0 || tile.currentX != tile.originX || tile.currentY != tile.originY){
			//contract
			var diffx = (tile.originX-tile.currentX)*0.2;
			var diffy = (tile.originY-tile.currentY)*0.2;
			var diffRot = (0-tile.rotation)*0.2;
			
			if(Math.abs(diffx) < 0.5){
				tile.currentX = tile.originX;
			}else{
				tile.currentX += diffx;
			}
			if(Math.abs(diffy) < 0.5){
				tile.currentY = tile.originY;
			}else{
				tile.currentY += diffy;
			}
			if(Math.abs(diffRot) < 0.5){
				tile.rotation = 0;
			}else{
				tile.rotation += diffRot;
			}
		}else{
			tile.force = 0;
		}
		draw.save();
		draw.translate(tile.currentX, tile.currentY);
		draw.rotate(tile.rotation*RAD);
		draw.drawImage(copycanvas, tile.videoX, tile.videoY, TILE_WIDTH, TILE_HEIGHT, -TILE_CENTER_WIDTH, -TILE_CENTER_HEIGHT, TILE_WIDTH, TILE_HEIGHT);
		draw.restore();
	}
	if(debug){
		debug = false;
		document.getElementById('trace').innerHTML = debugStr;
	}
}

function explode(x, y){
	for(var i=0; i<tiles.length; i++){
		var tile = tiles[i];
		
		var xdiff = tile.currentX-x;
		var ydiff = tile.currentY-y;
		var dist = Math.sqrt(xdiff*xdiff + ydiff*ydiff);
		
		var randRange = 220+(Math.random()*30);
		var range = randRange-dist;
		var force = 3*(range/randRange);
		if(force > tile.force){
			tile.force = force;
			var radians = Math.atan2(ydiff, xdiff);
			tile.moveX = Math.cos(radians);
			tile.moveY = Math.sin(radians);
			tile.moveRotation = 0.5-Math.random();
		}
	}
	tiles.sort(zindexSort);
	processFrame();
}
function zindexSort(a, b){
	return (a.force-b.force);
}

function dropBomb(evt, obj){
	var posx = 0;
	var posy = 0;
	var e = evt || window.event;
	if (e.pageX || e.pageY){
		posx = e.pageX;
		posy = e.pageY;
	}else if (e.clientX || e.clientY) {
		posx = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
		posy = e.clientY + document.body.scrollTop + document.documentElement.scrollTop;
	}
	var canvasX = posx-obj.offsetLeft;
	var canvasY = posy-obj.offsetTop;
	explode(canvasX, canvasY);
}

function Tile(){
	this.originX = 0;
	this.originY = 0;
	this.currentX = 0;
	this.currentY = 0;
	this.rotation = 0;
	this.force = 0;
	this.z = 0;
	this.moveX= 0;
	this.moveY= 0;
	this.moveRotation = 0;
	
	this.videoX = 0;
	this.videoY = 0;
}


/*
	getPixel
	return pixel object {r,g,b,a}
*/
function getPixel(imageData, x, y){
	var data = imageData.data;
	var pos = (x + y * imageData.width) * 4;
	return {r:data[pos], g:data[pos+1], b:data[pos+2], a:data[pos+3]}
}
/*
	setPixel
	set pixel object {r,g,b,a}
*/
function setPixel(imageData, x, y, pixel){
	var data = imageData.data;
	var pos = (x + y * imageData.width) * 4;
	data[pos] = pixel.r;
	data[pos+1] = pixel.g;
	data[pos+2] = pixel.b;
	data[pos+3] = pixel.a;
}
/*
	copyPixel
	faster then using getPixel/setPixel combo
*/
function copyPixel(sImageData, sx, sy, dImageData, dx, dy){
	var spos = (sx + sy * sImageData.width) * 4;
	var dpos = (dx + dy * dImageData.width) * 4;
	dImageData.data[dpos] = sImageData.data[spos];     //R
	dImageData.data[dpos+1] = sImageData.data[spos+1]; //G
	dImageData.data[dpos+2] = sImageData.data[spos+2]; //B
	dImageData.data[dpos+3] = sImageData.data[spos+3]; //A
}
/**********************************************************/
    
    
    
    

</script>
    
</body>    
</html>