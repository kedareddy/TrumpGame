<!DOCTYPE html>
<html>
<head>
    <!--All your imports & meta tags-->
    <meta charset="UTF-8" />
    <title>Instance Branch Template</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Canvas Library --> 
    <script type="text/javascript" src="/js/fabric.min.js"></script>
    
    <!-- import JQuery --> 
    <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    
    <!-- spinner for loading --> 
    <script src="/js/spin.min.js"></script>
</head>
<body>
<section class="section main">
    <div class="container left">
        <!-- Logo & Nav options --> 
        <div class="div header">
           <img class="logo" src="/images/bluelogo.svg">  
        </div>
    </div>
    <div class="container middle" id="middlecontainer">
        <div class="canvascontainer" id="canvasesdiv">
            <!--Canvas with editor--> 
            <video class="video" id="videoElement" width="150" height="75" src="https://media.giphy.com/media/3rgXBvnbXtxwaWmhr2/giphy.mp4" style="display:none;" autoplay="autoplay" loop="loop"></video>
            <!--<canvas class="canvas main" id="maincanvas"></canvas>-->
        </div>
    </div>
    <div class="container right">
        <!-- Edit Button 
        <button class="button edit" id="editbutton">Edit</button>-->
    </div>
</section>
    
<style> 
    .section.main{display: table; font-family: 'Oswald medium', sans-serif; color: gray;}
    
    .container.left{ display: table-cell; width: 20%; vertical-align: top;padding: 1%;}
    .container.middle{display: table-cell; width: 60%; height: auto;/*border-style: solid; */text-align: center;/* background-color: gainsboro;*/}
    .container.right{ display: table-cell; width:  20%; vertical-align: top; padding: 1%;}
    
    .canvascontainer{margin-left: auto; margin-right: auto; position: relative; }
    .canvas-container{margin-left: auto; margin-right: auto; position: absolute;left: 0; right: 0; }
    .lower-canvas{box-shadow: 10px 10px 25px rgba(0,0,0,.5);border-radius: 2.5%/5%;margin-top: 10%; margin-bottom: 10%;}
    /*canvas{}*/
    .video{margin-left: auto; margin-right: auto;}
    .div.header{margin: .5em;}
    .logo{width: 100%; height: auto;}
    
    .nodecanvas{padding: 12% 20% 0% 10%;}
    .modal.content { background-color: #fefefe;margin: auto;padding: 20px;border: 1px solid #888;width: 60%; height: 60%;}

    
    .button {border-style: solid; border-radius: 0px; padding: .5em; text-align: center; display: inline-block; font-size: 1em; cursor: pointer; box-shadow: none;  }
</style>       

<script>
    
//var canvas = new fabric.Canvas('maincanvas');
// Add a new rectangular canvas with fill representing specified gradient
var allCanvases = []; 
var allFabricObjects = []; 
var allStartEndTimes = []; 
var allVideos = []; 
    
function addTimeHandler(nVideo, startTime, endTime){
    nVideo.addEventListener('timeupdate', parentVideoListener(nVideo, startTime, endTime));
}
var parentVideoListener = function (nVideo, sT, eT) {
    return function(err) { 
            if (nVideo.currentTime >= eT) {
                nVideo.pause(); 
                nVideo.currentTime = sT;
                nVideo.play();
                console.log("in newVideo callback");
            }
    };
};    
    
$(document).ready(function(){

    var game_id = window.location.toString().split('?')[1];
    if(game_id){
		var dataUrl = 'https://api.mlab.com/api/1/databases/heroku_bsmmjq6z/collections/Library/'+game_id+'?apiKey=lJBb-_YOK_hCBfJ3_jL5kmDbaL5Xs1p-';
		$.ajax({url:dataUrl,type: "GET",contentType: "application/json"}).done(function( jsonData ) {
            console.log("inside ajax callback *****");
            if(jsonData){
                console.log("inside jsonData *****");
                //console.log('stored: ', jsonData);
                console.log("OrderType: " + jsonData.order + " IType: " + jsonData.inputType + " TransitionT: " + jsonData.transition); 
                console.log("inside jsonData *****");
                for(var j = 0; j < jsonData['scenes'].length; j++){
                    //create div to hold the canvas for the scene
                    var canvasDiv = document.getElementById("canvasesdiv");
                    var newCanvas = document.createElement("canvas");
                    canvasDiv.appendChild(newCanvas);
                    var canvas = new fabric.Canvas(newCanvas, {width: 500, height:50});
                    newCanvas.parentElement.style.position = "absolute";
                    
                    
                    var canvasStr = jsonData['scenes'][j];
                    
                    var sceneJSON = JSON.parse(canvasStr);
                    //console.log("sceneJSON: " + canvasStr); 
                    var sceneObjects = sceneJSON.objects;
                    //console.log("incoming width: " + sceneJSON.width + "incoming height: " + sceneJSON.height);
                    canvas.setHeight(sceneJSON.height);
                    canvas.setWidth(sceneJSON.width);
                    if(j == 0){
                        $("#middlecontainer").height(sceneJSON.height + (.2*document.body.offsetHeigh));
                    }
                    
                    for (var i = 0; i < sceneObjects.length; i++) {
                        var klass = fabric.util.getKlass(sceneObjects[i].type);
                        
                        if (klass.async) {
                            console.log("object type: " + sceneObjects[i].type);
                            console.log("object src: " + sceneObjects[i].src);
                            //var videoID = "video00";//+currentSceneNumber; 
                            
                            var newVideo = document.createElement("video");
                            newVideo.src = sceneObjects[i].src; 
                            newVideo.style.display = "none";
                            
                            //newVideo.autoPlay = true; 
                            /*if(i == 0){
                                newVideo.loop = true;
                            }*/
                            //if(j == 0){
                                
                                var urlText = sceneObjects[i].src;
                                var indexTC = urlText.indexOf("#t=");
                                var timeCodes = urlText.slice(indexTC+3).split(","); 
                                console.log("!!!!!!!!!!!timeCodes: " + timeCodes[0] + " :: " + timeCodes[1]); 
                                var startTime = timeCodes[0]; 
                                var endTime = timeCodes[1]; 
                                allStartEndTimes.push({"s":startTime, "e":endTime});
                                
                                allVideos.push(newVideo); 
                                /*newVideo.addEventListener('timeupdate', function (sT, eT) {
                                    return function(err) { 
                                        if (newVideo.currentTime >= endTime) {
                                            newVideo.currentTime = startTime;
                                            newVideo.play();
                                            console.log("in newVideo callback");
                                        }
                                    };
                                }(startTime, endTime), false);*/
                                if(j == 0)
                                {                                
                                    addTimeHandler(newVideo, startTime, endTime);
                                }
                            
                                
                                var backVideo = document.createElement("video");
                                //backVideo.autoPlay = true; 
                                backVideo.src = newVideo.src;
                                backVideo.style.display = "none";
                                //backVideo.crossOrigin = "anonymous";
                            
                                console.log("inbackVideo"); 
                                backVideo.addEventListener("loadeddata", function(sT){
                                    return function(err) { 
                                        backVideo.currentTime = sT;
                                        console.log("in backVideo callback");
                                    };
                                }(startTime), false);
                
                                canvasDiv.appendChild(backVideo);

                                var videoB = new fabric.Image(backVideo, {
                                      left: sceneObjects[i].left,
                                      top: sceneObjects[i].top,
                                      width: sceneObjects[i].width, 
                                      height: sceneObjects[i].height
                                });
                                
                                canvas.add(videoB);
                            //}
                            
                            canvasDiv.appendChild(newVideo);
                            //var videoCustomElement = document.getElementById("videoElement");
                            //$("#videoElement").attr("src", sceneObjects[i].src); 
                            var videoT = new fabric.Image(newVideo, {
                                  left: sceneObjects[i].left,
                                  top: sceneObjects[i].top,
                                  width: sceneObjects[i].width, 
                                  height: sceneObjects[i].height
                            });
                            
                            canvas.add(videoT);
                            videoT.getElement().play();
                                  /*videoT.getElement().addEventListener('timeupdate', function (domEl) {
                                      return function(err) { 
                                        if (domEl.currentTime >= endTime) {
                                            domEl.currentTime = startTime;
                                            domEl.play();
                                            console.log("in newVideo callback");
                                        }
                                    };
                                }(videoT.getElement()),false);*/
                            canvas.renderAll();
                        
                        } else {
                            canvas.add(klass.fromObject(sceneObjects[i]));
                            canvas.renderAll();
                        }
                    }
                    allFabricObjects.push(canvas);
                    allCanvases.push(newCanvas);
                    if(j != 0){
                        $(newCanvas).hide();
                    }
                }
                
                //console.log('templateURL: ', jsonData['scenes'][0]['url']);
                //$('#parentgif').attr("src", jsonData['scenes'][0]['url']);
                //$('#punchgif').attr("src", jsonData['scenes'][1]['url']);
                //textScene1 = jsonData['scenes'][0]['text'];
                //textScene2 = jsonData['scenes'][1]['text'];
                //$("#text").html(textScene1);
            }
  
		}).fail(function(jqXHR, textStatus, errorThrown )  {
            console.log(jqXHR);
            console.log(textStatus);
            console.log(errorThrown);
        }); 
	}
    
    fabric.util.requestAnimFrame(function render() {
        for(var i =0; i < allCanvases.length; i++){
            allFabricObjects[i].renderAll();            
        }
        fabric.util.requestAnimFrame(render);
    });

  
    $("#middlecontainer").on('mousedown',function(){
        $(".lower-canvas").css('box-shadow', '10px 10px 25px rgba(0,0,0,.5) inset');
    });
    
    $("#middlecontainer").on('mouseup',function(){
       /* var myH = $(".lower-canvas").height();
        var myW = $(".lower-canvas").width();
        var myL = $(".lower-canvas").position().left; 
        var myT = $(".lower-canvas").position().top; 
        $(".lower-canvas").animate({height: (myH+20).toString(), width: (myW+20).toString(), left: (myL-10).toString(), top: (myT-10).toString()}, 150);
        $(".lower-canvas").animate({height: (myH).toString(), width: (myW).toString(), left: (myL).toString(), top: (myT).toString()}, 100);
        $(".lower-canvas").css('box-shadow', '10px 10px 25px rgba(0,0,0,.5)');*/
    });
    
    //implement InstanceBranching logic on click/click-hold switch out the canvases. 
    $( "#middlecontainer" ).on('touchend click', function(){
        console.log("clicked!");
        if(openForInput == true){
            console.log("should play second clip");
            openForInput = false;
            
            //get parent video, remove its event listener & hide its canvas
            parentVid = allVideos[0];
            parentVid.removeEventListener("timeupdate", parentVideoListener);
            $(allCanvases[0]).hide();
            
            //pick a random child scenes, show its canvas, get it's video and set it to its start and play it. 
            console.log("max: " + (allCanvases.length-1)); 
            randomChildNum = getRandomInt(1, (allCanvases.length-1));
            $(allCanvases[randomChildNum]).show();
            currentVidEl = allVideos[randomChildNum];
            currentVidEl.pause();
            currentVidEl.currentTime = allStartEndTimes[randomChildNum].s;
            currentVidEl.play();
            
            currentVidS = allStartEndTimes[randomChildNum].s; 
            currentVidE = allStartEndTimes[randomChildNum].e; 
            
            //add a listener to the child video so you can turn it off once it's done playing or reaches its end
            hideOnce = true; 
            console.log("randINt getting sent over: " + randomChildNum); 
            addSecondTimeHandler();
            
             $(".lower-canvas").css('box-shadow', '10px 10px 25px rgba(0,0,0,.5) inset');
            
            
        }
        
    });
    
}); 
    
var parentVid = null;     
var hideOnce = true; 
var openForInput = true; 
var randomChildNum = 1; 
var currentVidEl;
var currentVidS; 
var currentVidE; 
function addSecondTimeHandler(){
    console.log("in addhandler lkajs dlfkj fuck im");
    currentVidEl.addEventListener('timeupdate', childVideoListener);
} 
    
var childVideoListener = function (){
    //return function(err) { 
        //console.log("currentTime: " + currentVidEl.currentTime + "supposed: " + currentVidE); 
        if (currentVidEl.currentTime >= currentVidE) {
            //make sure parent doesn't get set multiple times. 
            if(hideOnce == true){
                hideOnce = false; 
                //console.log('video ended' + "randnumber: " + randomChildNum);

                //hide the child canvas and show the parent canvas
                $(allCanvases[randomChildNum]).hide();
                $(allCanvases[0]).show();

                //set parent video start time & play
                parentVid.currentTime = allStartEndTimes[0].s;
                parentVid.play();
                //add the time handler back to the parent so it can loop
                addTimeHandler(parentVid, allStartEndTimes[0].s, allStartEndTimes[0].e);
                //open to listen to input again
                openForInput = true;
                //don't need this event listener anymore
                currentVidEl.removeEventListener('timeupdate', childVideoListener);   
                
                  var myH = $(".lower-canvas").height();
        var myW = $(".lower-canvas").width();
        var myL = $(".lower-canvas").position().left; 
        var myT = $(".lower-canvas").position().top; 
        $(".lower-canvas").animate({height: (myH+20).toString(), width: (myW+20).toString(), left: (myL-10).toString(), top: (myT-10).toString()}, 150);
        $(".lower-canvas").animate({height: (myH).toString(), width: (myW).toString(), left: (myL).toString(), top: (myT).toString()}, 100);
        $(".lower-canvas").css('box-shadow', '10px 10px 25px rgba(0,0,0,.5)');
                
            }
        }
   // };
};    
        
    
function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}
    

/********************!!!!!!!!!!!!!!!!!!!*******************/
    var video;
var copy;
var copycanvas;
var draw;

var TILE_WIDTH = 32;
var TILE_HEIGHT = 24;
var TILE_CENTER_WIDTH = 16;
var TILE_CENTER_HEIGHT = 12;
var SOURCERECT = {x:0, y:0, width:0, height:0};
var PAINTRECT = {x:0, y:0, width:1000, height:600};

function init(){
	video = document.getElementById('sourcevid');
	copycanvas = document.getElementById('sourcecopy');
	copy = copycanvas.getContext('2d');
	var outputcanvas = document.getElementById('output');
	draw = outputcanvas.getContext('2d');
	setInterval("processFrame()", 33);
}
function createTiles(){
	var offsetX = TILE_CENTER_WIDTH+(PAINTRECT.width-SOURCERECT.width)/2;
	var offsetY = TILE_CENTER_HEIGHT+(PAINTRECT.height-SOURCERECT.height)/2;
	var y=0;
	while(y < SOURCERECT.height){
		var x=0;
		while(x < SOURCERECT.width){
			var tile = new Tile();
			tile.videoX = x;
			tile.videoY = y;
			tile.originX = offsetX+x;
			tile.originY = offsetY+y;
			tile.currentX = tile.originX;
			tile.currentY = tile.originY;
			tiles.push(tile);
			x+=TILE_WIDTH;
		}
		y+=TILE_HEIGHT;
	}
}

var RAD = Math.PI/180;
var randomJump = false;
var tiles = [];
var debug = false;
function processFrame(){
	if(!isNaN(video.duration)){
		if(SOURCERECT.width == 0){
			SOURCERECT = {x:0,y:0,width:video.videoWidth,height:video.videoHeight};
			createTiles();
		}
		//this is to keep my sanity while developing
		if(randomJump){
			randomJump = false;
			video.currentTime = Math.random()*video.duration;
		}
		//loop
		if(video.currentTime == video.duration){
			video.currentTime = 0;
		}
	}
	var debugStr = "";
	//copy tiles
	copy.drawImage(video, 0, 0);
	draw.clearRect(PAINTRECT.x, PAINTRECT.y,PAINTRECT.width,PAINTRECT.height);
	
	for(var i=0; i<tiles.length; i++){
		var tile = tiles[i];
		if(tile.force > 0.0001){
			//expand
			tile.moveX *= tile.force;
			tile.moveY *= tile.force;
			tile.moveRotation *= tile.force;
			tile.currentX += tile.moveX;
			tile.currentY += tile.moveY;
			tile.rotation += tile.moveRotation;
			tile.rotation %= 360;
			tile.force *= 0.9;
			if(tile.currentX <= 0 || tile.currentX >= PAINTRECT.width){
				tile.moveX *= -1;
			}
			if(tile.currentY <= 0 || tile.currentY >= PAINTRECT.height){
				tile.moveY *= -1;
			}
		}else if(tile.rotation != 0 || tile.currentX != tile.originX || tile.currentY != tile.originY){
			//contract
			var diffx = (tile.originX-tile.currentX)*0.2;
			var diffy = (tile.originY-tile.currentY)*0.2;
			var diffRot = (0-tile.rotation)*0.2;
			
			if(Math.abs(diffx) < 0.5){
				tile.currentX = tile.originX;
			}else{
				tile.currentX += diffx;
			}
			if(Math.abs(diffy) < 0.5){
				tile.currentY = tile.originY;
			}else{
				tile.currentY += diffy;
			}
			if(Math.abs(diffRot) < 0.5){
				tile.rotation = 0;
			}else{
				tile.rotation += diffRot;
			}
		}else{
			tile.force = 0;
		}
		draw.save();
		draw.translate(tile.currentX, tile.currentY);
		draw.rotate(tile.rotation*RAD);
		draw.drawImage(copycanvas, tile.videoX, tile.videoY, TILE_WIDTH, TILE_HEIGHT, -TILE_CENTER_WIDTH, -TILE_CENTER_HEIGHT, TILE_WIDTH, TILE_HEIGHT);
		draw.restore();
	}
	if(debug){
		debug = false;
		document.getElementById('trace').innerHTML = debugStr;
	}
}

function explode(x, y){
	for(var i=0; i<tiles.length; i++){
		var tile = tiles[i];
		
		var xdiff = tile.currentX-x;
		var ydiff = tile.currentY-y;
		var dist = Math.sqrt(xdiff*xdiff + ydiff*ydiff);
		
		var randRange = 220+(Math.random()*30);
		var range = randRange-dist;
		var force = 3*(range/randRange);
		if(force > tile.force){
			tile.force = force;
			var radians = Math.atan2(ydiff, xdiff);
			tile.moveX = Math.cos(radians);
			tile.moveY = Math.sin(radians);
			tile.moveRotation = 0.5-Math.random();
		}
	}
	tiles.sort(zindexSort);
	processFrame();
}
function zindexSort(a, b){
	return (a.force-b.force);
}

function dropBomb(evt, obj){
	var posx = 0;
	var posy = 0;
	var e = evt || window.event;
	if (e.pageX || e.pageY){
		posx = e.pageX;
		posy = e.pageY;
	}else if (e.clientX || e.clientY) {
		posx = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
		posy = e.clientY + document.body.scrollTop + document.documentElement.scrollTop;
	}
	var canvasX = posx-obj.offsetLeft;
	var canvasY = posy-obj.offsetTop;
	explode(canvasX, canvasY);
}

function Tile(){
	this.originX = 0;
	this.originY = 0;
	this.currentX = 0;
	this.currentY = 0;
	this.rotation = 0;
	this.force = 0;
	this.z = 0;
	this.moveX= 0;
	this.moveY= 0;
	this.moveRotation = 0;
	
	this.videoX = 0;
	this.videoY = 0;
}


/*
	getPixel
	return pixel object {r,g,b,a}
*/
function getPixel(imageData, x, y){
	var data = imageData.data;
	var pos = (x + y * imageData.width) * 4;
	return {r:data[pos], g:data[pos+1], b:data[pos+2], a:data[pos+3]}
}
/*
	setPixel
	set pixel object {r,g,b,a}
*/
function setPixel(imageData, x, y, pixel){
	var data = imageData.data;
	var pos = (x + y * imageData.width) * 4;
	data[pos] = pixel.r;
	data[pos+1] = pixel.g;
	data[pos+2] = pixel.b;
	data[pos+3] = pixel.a;
}
/*
	copyPixel
	faster then using getPixel/setPixel combo
*/
function copyPixel(sImageData, sx, sy, dImageData, dx, dy){
	var spos = (sx + sy * sImageData.width) * 4;
	var dpos = (dx + dy * dImageData.width) * 4;
	dImageData.data[dpos] = sImageData.data[spos];     //R
	dImageData.data[dpos+1] = sImageData.data[spos+1]; //G
	dImageData.data[dpos+2] = sImageData.data[spos+2]; //B
	dImageData.data[dpos+3] = sImageData.data[spos+3]; //A
}
/**********************************************************/
    
    
    
    

</script>
    
</body>    
</html>