<!DOCTYPE html>
<html>
<head>
    <!--All your imports & meta tags-->
    <meta charset="UTF-8" />
    <title>Instance Branch Template</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Canvas Library --> 
    <script type="text/javascript" src="/js/fabric.min.js"></script>
    
    <!-- import JQuery --> 
    <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    
    <!-- spinner for loading --> 
    <script src="/js/spin.min.js"></script>
</head>
<body>
<section class="section main">
    <div class="container left">
        <!-- Logo & Nav options --> 
        <div class="div header">
           <img class="logo" src="/images/bluelogo.svg">  
        </div>
    </div>
    <div class="container middle" id="middlecontainer">
        <div class="canvascontainer" id="canvasesdiv">
            <!--Canvas with editor--> 
            <video class="video" id="videoElement" width="150" height="75" src="https://media.giphy.com/media/3rgXBvnbXtxwaWmhr2/giphy.mp4" style="display:none;" autoplay="autoplay" loop="loop"></video>
            <!--<canvas class="canvas main" id="maincanvas"></canvas>-->
        </div>
    </div>
    <div class="container right">
        <!-- Edit Button --> 
        <button class="button edit" id="editbutton">Edit</button>
    </div>
</section>
    
<style> 
    .section.main{display: table; font-family: 'Oswald medium', sans-serif; color: gray;}
    
    .container.left{ display: table-cell; width: 20%; vertical-align: top;padding: 1%;}
    .container.middle{display: table-cell; width: 60%; border-style: solid; text-align: center; background-color: black;}
    .container.right{ display: table-cell; width:  20%; vertical-align: top; padding: 1%;}
    
    .canvascontainer{margin-left: auto; margin-right: auto; position: relative; }
    .canvas-container{margin-left: auto; margin-right: auto; position: absolute;left: 0; right: 0; }
    .video{margin-left: auto; margin-right: auto;}
    .div.header{margin: .5em;}
    .logo{width: 100%; height: auto;}
    
    .nodecanvas{padding: 12% 20% 0% 10%;}
    .modal.content { background-color: #fefefe;margin: auto;padding: 20px;border: 1px solid #888;width: 60%; height: 60%;}

    
    .button {border-style: solid; border-radius: 0px; padding: .5em; text-align: center; display: inline-block; font-size: 1em; cursor: pointer; box-shadow: none;  }
</style>       

<script>
    
//var canvas = new fabric.Canvas('maincanvas');
// Add a new rectangular canvas with fill representing specified gradient
var allCanvases = []; 
var allFabricObjects = []; 
    
$(document).ready(function(){

    var game_id = window.location.toString().split('?')[1];
    if(game_id){
		var dataUrl = 'https://api.mlab.com/api/1/databases/heroku_bsmmjq6z/collections/Library/'+game_id+'?apiKey=lJBb-_YOK_hCBfJ3_jL5kmDbaL5Xs1p-';
		$.ajax({url:dataUrl,type: "GET",contentType: "application/json"}).done(function( jsonData ) {
            console.log("inside ajax callback *****");
            if(jsonData){
                console.log("inside jsonData *****");
                console.log('stored: ', jsonData);
                
                for(var j = 0; j < jsonData['scenes'].length; j++){
                    
                    var canvasDiv = document.getElementById("canvasesdiv");
                    var newCanvas = document.createElement("canvas");
                    canvasDiv.appendChild(newCanvas);
                    var canvas = new fabric.Canvas(newCanvas, {width: 500, height:50});
                    newCanvas.parentElement.style.position = "absolute";
                    
                    
                    var canvasStr = jsonData['scenes'][j];
                    
                    var sceneJSON = JSON.parse(canvasStr);
                    console.log("sceneJSON: " + canvasStr); 
                    var sceneObjects = sceneJSON.objects;
                    console.log("incoming width: " + sceneJSON.width + "incoming height: " + sceneJSON.height);
                    canvas.setHeight(sceneJSON.height);
                    canvas.setWidth(sceneJSON.width);
                    if(j == 0){
                        $("#middlecontainer").height(sceneJSON.height);
                    }
                    
                    for (var i = 0; i < sceneObjects.length; i++) {
                        var klass = fabric.util.getKlass(sceneObjects[i].type);
                        
                        if (klass.async) {
                            console.log("object type: " + sceneObjects[i].type);
                            console.log("object src: " + sceneObjects[i].src);
                            //var videoID = "video00";//+currentSceneNumber; 
                            
                            var newVideo = document.createElement("video");
                            newVideo.autoPlay = true; 
                            if(i == 0){
                                newVideo.loop = true;
                            }
                            newVideo.src = sceneObjects[i].src; 
                            newVideo.style.display = "none";
                            canvasDiv.appendChild(newVideo);
                            
                            
                            //var videoCustomElement = document.getElementById("videoElement");
                            //$("#videoElement").attr("src", sceneObjects[i].src); 
                            var videoT = new fabric.Image(newVideo, {
                                  left: sceneObjects[i].left,
                                  top: sceneObjects[i].top,
                                  width: sceneObjects[i].width, 
                                  height: sceneObjects[i].height
                            });
                            canvas.add(videoT);
                            videoT.getElement().play();
                            canvas.renderAll();
                        
                        } else {
                            canvas.add(klass.fromObject(sceneObjects[i]));
                            canvas.renderAll();
                        }
                    }
                    allFabricObjects.push(canvas);
                    allCanvases.push(newCanvas);
                    if(j != 0){
                        $(newCanvas).hide();
                    }
                }
                
                //console.log('templateURL: ', jsonData['scenes'][0]['url']);
                //$('#parentgif').attr("src", jsonData['scenes'][0]['url']);
                //$('#punchgif').attr("src", jsonData['scenes'][1]['url']);
                //textScene1 = jsonData['scenes'][0]['text'];
                //textScene2 = jsonData['scenes'][1]['text'];
                //$("#text").html(textScene1);
            }
  
		}).fail(function(jqXHR, textStatus, errorThrown )  {
            console.log(jqXHR);
            console.log(textStatus);
            console.log(errorThrown);
        }); 
	}
    
    fabric.util.requestAnimFrame(function render() {
        for(var i =0; i < allCanvases.length; i++){
            allFabricObjects[i].renderAll();            
        }
        fabric.util.requestAnimFrame(render);
    });

    var openForInput = true; 
    //implement InstanceBranching logic on click/click-hold switch out the canvases. 
    $( "#middlecontainer" ).on('touchend click', function(){
        console.log("clicked!");
        if(openForInput == true){
            openForInput = false;
            var parentVid = allFabricObjects[0].getObjects()[2].getElement(); 
            parentVid.pause();
            $(allCanvases[0]).hide();
            
            var randInt = getRandomInt(1, (allCanvases.length-1));
            $(allCanvases[randInt]).show();
        
            var vidEl = allFabricObjects[randInt].getObjects()[2].getElement();
            vidEl.pause();
            vidEl.currentTime = 0;
            vidEl.play();

            vidEl.onended = function(e) {
                console.log('video ended');
                $(allCanvases[randInt]).hide();
                $(allCanvases[0]).show();
                parentVid.play();
                parentVid.loop = true; 
                openForInput = true;
            }

        }
        
    });
    
}); 
    
function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

</script>
    
</body>    
</html>